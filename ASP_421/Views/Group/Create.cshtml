@model ASP_421.Models.Shop.API.ShopApiGroupFormModel
@using Microsoft.AspNetCore.Antiforgery;
@inject IAntiforgery Antiforgery
@{
    ViewData["Title"] = "Create Group";
    var anti = Antiforgery.GetAndStoreTokens(Context).RequestToken!;
}
<h2 class="mb-3">Create Group</h2>
<form id="groupForm" class="card p-3 shadow-sm" enctype="multipart/form-data">
    <div class="mb-3">
        <label class="form-label">Назва групи</label>
        <input class="form-control" name="group-name" />
        <small class="text-danger d-block" data-err="group-name"></small>
    </div>

    <div class="mb-3">
        <label class="form-label">Опис</label>
        <textarea class="form-control" name="group-description" rows="3"></textarea>
        <small class="text-danger d-block" data-err="group-description"></small>
    </div>

    <div class="mb-3">
        <label class="form-label">Slug</label>
        <input class="form-control" name="group-slug" />
        <small class="text-danger d-block" data-err="group-slug"></small>
    </div>

    <div class="mb-3">
        <label class="form-label">Батьківська група</label>
        <select class="form-select" name="group-parent-id">
            <option value="">верхній рівень</option>
            @if(ViewBag.ParentGroups is IEnumerable<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem> items)
                {
                foreach(var it in items)
                {
                    <option value="@it.Value">@it.Text</option>
                }
            }
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Зображення</label>
        <input class="form-control" type="file" name="group-image" accept="image/*" />
        <small class="text-danger d-block" data-err="group-image"></small>
    </div>

    <div class="d-flex gap-2">
        <button class="btn btn-primary" type="submit">Створити</button>
        <button class="btn btn-secondary" type="button" id="resetBtn">Очистити</button>
    </div>
    
    <div id="msg" class="mt-3"></div>
</form>


@section Scripts{
    <script>
        (function(){
            const form =document.getElementById('groupForm');
            const msg = document.getElementById('msg');
            const anti = '@anti';

            const inputs = Array.from(form.querySelectorAll('input[name^="group-"], textarea[name^="group-"]'));

            function clearErrors(){
                inputs.forEach(inputs=>i.classList.remove('is-invalid'));
                form.querySelectorAll('[data-err]').forEach(e=>e.textContent='');
                msg.innerHTML = '';
            } 

            function showErrors(errors)
            {
                clearErrors();
                Object.entries(errors || {}).forEach(([name, text]) =>
                    {
                    const input = form.querySelector(`[name="${name}"]`);
                    const span = form.querySelector(`[data-err="${name}"]`);
                    if(input) input.classList.add('is-invalid');
                    if(span) span.textContent = text;
                    });
                }

                form.addEventListener('submit', async(e) =>
                {
                    e.preventDefault();
                    clearErrors();

                    const data = new FormData(form;

                        try{
                            const res = await fetch('/api/group',{
                                method: 'POST',
                                headers: {'RequestVerificationToken': anti},
                                body: data
                            });

                            if(res.status === 400) {
                                const payload = await res.json();
                                showErrors(payload?.errors || payload);
                                return;
                            }

                            if(!res.ok{
                                msg.innerHTML = `<div class= "alert alert-danger">Помилка: ${res.status} ${res.statusText}</div>`;
                                return;
                            }

                            msg.innerHTML= `<div class="alert alert-success">Нова група створена</div>`;
                            form.reset();
                            clearErrors();
                        }
                        catch{
                            msg.innerHTML= `<div class="alert alert-danger">Помилка мережі</div>`;
                        }
                });

                document.getElementById('resetBtn').addEventListener('click', ()=>
                {
                    form.reset();
                    clearErrors();
                }); 
        })();
    </script>
}


       